---
title: "RPi Pico PIO + DMA è»¢é€è¦šæ›¸ (MicroPythonç‰ˆ)"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["raspberrypi", "micropython", "pio", "dma", "embedded"]
published: true
---

MicroPython ã‚’ç”¨ã„ã¦ Raspberry Pi Pico ã® PIO ã¨ DMA ã‚’ä½¿ã†æ–¹æ³•ã«ã¤ã„ã¦ã®è¦šæ›¸ã€‚ãã‚Œãã‚Œã®æƒ…å ±ã¯å…¥æ‰‹ã§ãã‚‹ãŒã€TX_FIFO/RX_FIFO ä¸¡æ–¹ã« DMA ã™ã‚‹ä¾‹ãŒãªã‹ã£ãŸã®ã§æ›¸ãæ®‹ã™ã€‚

æœ¬å†…å®¹ã¯ MicroPython ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸¦ã³ã« RP2040 ã®ä»•æ§˜æ›¸ã‹ã‚‰æŠœç²‹ã—ãŸå†…å®¹ã¨ãªã£ã¦ã„ã‚‹ã€‚

## HW ä¸Šé”æˆã™ã¹ãã“ã¨

`PIOx_BASE` + `(T|R)XFy` ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«èª­ã¿æ›¸ãã‚’è¡Œã†ã“ã¨ã€‚

ä»¥ä¸‹å†…å®¹ã‚ˆã‚Š PIO Address `x= (0|1)` ã¨
`(T|R)XFy` ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ `y= (0|1|2|3)` ã‚’çµ„ã¿åˆã‚ã›ã¦ã€PIO ã® TX_FIFO/RX_FIFO ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚

### `PIOx_BASE`

`PIOx_BASE` ã¯ã€PIO ã® Base Addressã€‚ 2.2. Address Map ã«ã¦ä»¥ä¸‹å®šç¾©ãŒãªã•ã‚Œã¦ã„ã‚‹ã€‚

- `PIO0_BASE` = `0x50200000`
- `PIO1_BASE` = `0x50300000`

### `(T|R)XFy`

`(T|R)XFy` ã¯ã€PIO ã® TX_FIFO/RX_FIFO ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã€‚Chapter 3. PIO 3.7. List of Registers ã«ã¦ä»¥ä¸‹å®šç¾©ãŒãªã•ã‚Œã¦ã„ã‚‹ã€‚

| Offset | Name   |
| ------ | ------ |
| 0x010  | `TXF0` |
| 0x014  | `TXF1` |
| 0x018  | `TXF2` |
| 0x01C  | `TXF3` |
| 0x020  | `RXF0` |
| 0x024  | `RXF1` |
| 0x028  | `RXF2` |
| 0x02C  | `RXF3` |

FIFO ã®ç©ºãã«é–¢é€£ã™ã‚‹æƒ…å ±ã¯ Offset 0x008 `FDEBUG` ãƒ¬ã‚¸ã‚¹ã‚¿ã® `TXSTALL`, `TXOVER`, `RXUNDER`, `RXSTALL` åŠã³ FLEVEL ã® `(T|R)Xy`ã‹ã‚‰ç¢ºèªã§ãã‚‹ã€‚

### DMA ã«ãŠã‘ã‚‹ FIFO Status ã®ç¢ºèª

DMA ãŒä¸€æ–¹çš„ã«ãƒ‡ãƒ¼ã‚¿è»¢é€ã—ã¦ã‚‚ FIFO ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã®ã«èª­ã¿å‡ºã—ãŸã‚Šã€ã‚ã‚‹ã®ã«æ›¸ãè¾¼ã‚“ã§æº¢ã‚Œã¦ã—ã¾ã†ã€‚ã“ã‚Œã‚’é˜²ããŸã‚ã€ãƒšãƒªãƒ•ã‚§ãƒ©ãƒ«ï¼ˆã“ã“ã§ã¯ PIOï¼‰ã®ãƒšãƒ¼ã‚¹ã§ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚’è¡Œãˆã‚‹ã‚ˆã†ãªã—ãã¿ãŒã‚ã‚Šã€ Data Request (DREQ) ã¨å‘¼ã°ã‚Œã‚‹è¨­å®šã‚’è¡Œã†ã€‚

2.5.3.1 System DREQ Table ã®è¨­å®šãŒã‚ã‚Šã€PIO ã«é–¢é€£ã™ã‚‹å†…å®¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

`DREQ# = PIO# * 4 + (4 if RX else 0) + SM#`

| PIO | SM  | PORT | DREQ# | Description      |
| --- | --- | ---- | ----- | ---------------- |
| 0   | 0   | TX   | 0     | PIO0 SM0 TX DREQ |
| 0   | 0   | TX   | 1     | PIO0 SM1 TX DREQ |
| 0   | 0   | TX   | 2     | PIO0 SM2 TX DREQ |
| 0   | 0   | TX   | 3     | PIO0 SM3 TX DREQ |
| 0   | 0   | RX   | 4     | PIO0 SM0 RX DREQ |
| 0   | 0   | RX   | 5     | PIO0 SM1 RX DREQ |
| 0   | 0   | RX   | 6     | PIO0 SM2 RX DREQ |
| 0   | 0   | RX   | 7     | PIO0 SM3 RX DREQ |
| 1   | 0   | TX   | 8     | PIO1 SM0 TX DREQ |
| 1   | 0   | TX   | 9     | PIO1 SM1 TX DREQ |
| 1   | 0   | TX   | 10    | PIO1 SM2 TX DREQ |
| 1   | 0   | TX   | 11    | PIO1 SM3 TX DREQ |
| 1   | 0   | RX   | 12    | PIO1 SM0 RX DREQ |
| 1   | 0   | RX   | 13    | PIO1 SM1 RX DREQ |
| 1   | 0   | RX   | 14    | PIO1 SM2 RX DREQ |
| 1   | 0   | RX   | 15    | PIO1 SM3 RX DREQ |

## MicroPython ã§ã®å®Ÿè£…

DMA class, PIO class, StateMachine class ã‚’ä½¿ã£ã¦ã€PIO ã® TX_FIFO/RX_FIFO ã« DMA è»¢é€ã‚’è¡Œã†ã€‚

å…¥åŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ Echo ã™ã‚‹ PIO ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ã€TX_FIFO ã¨ RX_FIFO ã®ä¸¡æ–¹ã« DMA è»¢é€ã‚’è¡Œã†ä¾‹ã‚’ç¤ºã™ã€‚

```python
# é€å—ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
tx_data = array.array("I", [0x12345678, 0x9ABCDEF0, 0xDEADBEEF, 0xFEEDFACE]) # test data
rx_data = array.array("I", [0] * len(tx_data))


# PIO ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®šç¾©
@rp2.asm_pio(
    # out, sideset, shiftæ–¹å‘, autopushç­‰ã®è¨­å®šãŒã“ã“ã§è¡Œãˆã‚‹
)
def pio_echoback():
    # PIO asmæœ¬ä½“ã€‚ã“ã“ã§ã¯TX_FIFOã®å†…å®¹ã‚’RX_FIFOã«ãã®ã¾ã¾è¿”ã™
    wrap_target()
    pull(block)
    out(x, 32)
    in_(x, 32)
    push(block)
    wrap()

# PIO0 State Machine 0ã‚’èµ·å‹•
sm0 = rp2.StateMachine(0)
sm0.init(
    prog=pio_echoback,
    freq=125_000_000,  # 125MHz
    # pinè¨­å®š, å‘¨æ³¢æ•°è¨­å®šç­‰ã®è¨­å®šãŒè¡Œãˆã‚‹
)
sm0.active(1)


# Setup TX DMA
tx_dma0 = rp2.DMA()
tx_dma0_ctrl = tx_dma0.pack_ctrl(
    size=2,  # 0=1byte, 1=2byte, 2=4byteè»¢é€
    inc_read=True,
    inc_write=False,  # PIO0 TXF0ã¯å ´æ‰€å›ºå®šãªã®ã§incrementã—ãªã„
    treq_sel=0,  # PIO0 SM0 TX DREQ
)
tx_dma0.config(
    read=tx_data,  # è»¢é€å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾æ¸¡ã™
    write=sm0,  # state machine ã‚’ãã®ã¾ã¾æ¸¡ã™
    count=len(
        tx_data
    ),  # è»¢é€byteæ•°ã§ã¯ãªãã€pack_ctrlã®sizeã§æŒ‡å®šã—ãŸå˜ä½ã§ã®è»¢é€æ•°ãªã®ã§æ³¨æ„
    ctrl=tx_dma0_ctrl,
    trigger=True,  # é–‹å§‹
)

# Setup RX DMA
rx_dma0 = rp2.DMA()
rx_dma0_ctrl = rx_dma0.pack_ctrl(
    size=2,  # 0=1byte, 1=2byte, 2=4byteè»¢é€
    inc_read=False,  # PIO0 RXF0ã¯å ´æ‰€å›ºå®šãªã®ã§incrementã—ãªã„
    inc_write=True,
    treq_sel=4,  # PIO0 SM0 RX DREQ
)
rx_dma0.config(
    read=sm0,  # state machine ã‚’ãã®ã¾ã¾æ¸¡ã™
    write=rx_data,  # è»¢é€å…ˆãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾æ¸¡ã™
    count=len(
        tx_data
    ),  # è»¢é€byteæ•°ã§ã¯ãªãã€pack_ctrlã®sizeã§æŒ‡å®šã—ãŸå˜ä½ã§ã®è»¢é€æ•°ãªã®ã§æ³¨æ„
    ctrl=rx_dma0_ctrl,
    trigger=True,
)

# è»¢é€å®Œäº†å¾…ã¡
while rx_dma0.active():
    pass

# çµæœç¢ºèª
for i in range(len(rx_data)):
    print(f"TX Data[{i}]: {tx_data[i]:#010x}, RX Data[{i}]: {rx_data[i]:#010x}")
    assert tx_data[i] == rx_data[i], (
        f"Data mismatch at index {i}: {tx_data[i]:#010x} != {rx_data[i]:#010x}"
    )

# çµ‚äº†å‡¦ç†
sm0.active(0)
tx_dma0.close()
rx_dma0.close()
```

å‡ºåŠ›

```log
TX Data[0]: 0x12345678, RX Data[0]: 0x12345678
TX Data[1]: 0x9abcdef0, RX Data[1]: 0x9abcdef0
TX Data[2]: 0xdeadbeef, RX Data[2]: 0xdeadbeef
TX Data[3]: 0xfeedface, RX Data[3]: 0xfeedface
```

## Tips

### byteswap ã—ãŸã„

pio program ä¸­ã§ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ãŒå…¥ã‚Œæ›¿ã‚ã£ã¦ã—ã¾ã†ã‚±ãƒ¼ã‚¹ãªã©ã‚’æƒ³å®šã€‚BSWAP option ãŒã‚ã‚Šã€ã“ã‚Œã¯ DMA ã®è¨­å®šã§è¡Œãˆã‚‹

```python
# Setup RX DMA
rx_dma0 = rp2.DMA()
rx_dma0_ctrl = rx_dma0.pack_ctrl(
    size=2,  # 0=1byte, 1=2byte, 2=4byteè»¢é€
    inc_read=False,  # PIO0 RXF0ã¯å ´æ‰€å›ºå®šãªã®ã§incrementã—ãªã„
    inc_write=True,
    bswap=True,  # å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã¯Big Endianãªã®ã§ã€ãƒã‚¤ãƒˆã‚ªãƒ¼ãƒ€ãƒ¼ã‚’åè»¢
    treq_sel=4,  # PIO0 SM0 RX DREQ
)
```

å®Ÿè¡Œçµæœ

```log
TX Data[0]: 0x12345678, RX Data[0]: 0x78563412
Traceback (most recent call last):
  File "<stdin>", line 444, in <module>
AssertionError: Data mismatch at index 0: 0x12345678 != 0x78563412
```

### 1byte ãšã¤è»¢é€ã—ãŸã„

`size=0` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€1byte ãšã¤è»¢é€ã§ãã‚‹ã€‚è»¢é€ã‚«ã‚¦ãƒ³ãƒˆæ•°ã«æ³¨æ„

```python
# Setup TX DMA
tx_dma0 = rp2.DMA()
tx_dma0_ctrl = tx_dma0.pack_ctrl(
    size=0,  # 0=1byte, 1=2byte, 2=4byteè»¢é€
    inc_read=True,
    inc_write=False,  # PIO0 TXF0ã¯å ´æ‰€å›ºå®šãªã®ã§incrementã—ãªã„
    treq_sel=0,  # PIO0 SM0 TX DREQ
)
tx_dma0.config(
    read=tx_data,  # è»¢é€å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾æ¸¡ã™
    write=sm0,  # state machine ã‚’ãã®ã¾ã¾æ¸¡ã™
    count=len(tx_data) * 4,  # è»¢é€byteæ•°ã§ã¯ãªãã€pack_ctrlã®sizeã§æŒ‡å®šã—ãŸå˜ä½ã§ã®è»¢é€æ•°ãªã®ã§æ³¨æ„
    ctrl=tx_dma0_ctrl,
    trigger=True,  # é–‹å§‹
)

# RXå´ã‚‚åŒæ§˜ã«ä¿®æ­£
```

çµæœ

```log
TX Data[0]: 0x12345678, RX Data[0]: 0x12345678
TX Data[1]: 0x9abcdef0, RX Data[1]: 0x9abcdef0
TX Data[2]: 0xdeadbeef, RX Data[2]: 0xdeadbeef
TX Data[3]: 0xfeedface, RX Data[3]: 0xfeedface
```

### sniff ã—ãŸã„ã€chain ã—ãŸã„ã€...

`DMA.pack_ctrl()` ã‚„åœ’å‘¨è¾ºã‚’èª­ã‚€ã¨æ¦‚ã­ã‚„ã‚ŠãŸã„ã“ã¨ã¯è¨˜è¼‰ãŒã‚ã‚‹ã¯ãšã€‚å…ˆã«ç¤ºã—ãŸä¾‹ã‚’ä¸‹ã«æ”¹é€ ãƒ»æ”¹è‰¯ã—ã¦ã„ãã“ã¨ã‚’æ¨å¥¨ã€‚

[MicroPython library - rp2.DMA](https://micropython-docs-ja.readthedocs.io/ja/latest/library/rp2.DMA.html#rp2.DMA.pack_ctrl)

## çµ‚ã‚ã‚Šã«

`DMA.config` ã® `read`, `write` ã« Peripheral ãŒæ¥ã‚‹ã‚±ãƒ¼ã‚¹ã§ã®æŒ‡å®šãŒã„ã¾ã„ã¡èª­ã¿å–ã‚Šã¥ã‚‰ã‹ã£ãŸã®ã§æ›¸ãæ®‹ã—ãŸã€‚

## Reference

- [MicroPython library - rp2](https://micropython-docs-ja.readthedocs.io/ja/latest/library/rp2.html)
- [RP2040 Datasheet](https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf)
