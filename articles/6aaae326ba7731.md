---
title: "LiteX ã‚’ Ubuntu 24.04 on WSL2 ã§ä½¿ç”¨ã—ã€ Demo Applicationã‚’å‹•ä½œã•ã›ã‚‹"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["tech", "litex", "fpga", "Linux", "Embedded"]
published: true
---

LiteX ã‚’ Windows ç’°å¢ƒã§ä½¿ç”¨ã—ãŸãã€è©¦ã—ã¦ã„ãŸã¨ãã®å‚™å¿˜éŒ²ã€‚ä»¥ä¸‹ã®é€šã‚Šç„¡äº‹ demo app ã®å‹•ä½œç¢ºèªã¾ã§ãŸã©ã‚Šç€ã‘ãŸã®ã§æ›¸ãæ®‹ã™ã€‚

![movie gif](/images/6aaae326ba7731/vexriscv-donut.mp4.gif)

---

## æ‰‹é †ã¾ã¨ã‚

æ™‚ç³»åˆ—é †ã«å®Ÿè¡Œã—ãŸå†…å®¹ã®ã¾ã¨ã‚ã‚’å…ˆã«è¨˜è¼‰ã™ã‚‹ã€‚ç´°ã‹ã„ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯å¾ŒåŠã«è¨˜è¼‰ã€‚

### ç’°å¢ƒæ§‹ç¯‰

åŸºæœ¬æ‰‹é †ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® Quick Start Guide](https://github.com/enjoy-digital/litex?tab=readme-ov-file#quick-start-guide)ã«å¾“ã„ã€WSL2 ä¸Šã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ Ubuntu 24.04 ã§è¡Œã†ã€‚
è¦ç‚¹ã¯ä»¥ä¸‹ã€‚

- virtualenv ã‚’ä½œæˆã—ã€Python ä»®æƒ³ç’°å¢ƒä¸­ã§å®Ÿè¡Œã™ã‚‹
- virtualenv ä¸­ã§ user install ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ã€ `--user` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ãªã„
- litex ã® repo ã”ã¨å–å¾—ã—ãŸçŠ¶æ…‹ã§ `litex_setup.py` ã‚’å®Ÿè¡Œã—ãªã„

```sh
# verilatorå°å…¥
$ sudo apt install verilator

# litexã®å–å¾—
$ wget https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py
$ chmod +x litex_setup.py

# venvå°å…¥
$ sudo apt install python3-venv
# ä»®æƒ³ç’°å¢ƒä½œæˆ + activate
$ python3 -m venv .venv
$ source .venv/bin/activate

# litex_setup.py ã®å®Ÿè¡Œ
$ python3 ./litex_setup.py --init --install --config=full

# RSC-V toolchain ã®å°å…¥ (binutils-riscv* ç­‰ãŒå°å…¥ã•ã‚Œã‚‹ã®ã§ç®¡ç†è€…æ¨©é™å¿…è¦)
$ pip3 install meson ninja
$ sudo ./litex_setup.py --gcc=riscv
```

### å®Ÿæ©Ÿç„¡ã—ã§ã®ãƒ†ã‚¹ãƒˆ

ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆã¯ç‰¹ã«ãªã—ã€‚verilator ãŒã‚ã‚Œã°å‹•ãã¯ãšã€‚

```bash
# sim ã«å¿…è¦ãªPackageå°å…¥
$ sudo apt install libevent-dev libjson-c-dev verilator
$ litex_sim --cpu-type=vexriscv

...
[ethernet] loaded (0x55b1423482f0)
[jtagremote] loaded (0x55b1423482f0)
[spdeeprom] loaded (addr = 0x0)
[serial2tcp] loaded (0x55b1423482f0)
[gmii_ethernet] loaded (0x55b1423482f0)
[xgmii_ethernet] loaded (0x55b1423482f0)
[serial2console] loaded (0x55b1423482f0)
[clocker] loaded
[clocker] sys_clk: freq_hz=1000000, phase_deg=0

        __   _ __      _  __
       / /  (_) /____ | |/_/
      / /__/ / __/ -_)>  <
     /____/_/\__/\__/_/|_|
   Build your hardware, easily!

 (c) Copyright 2012-2024 Enjoy-Digital
 (c) Copyright 2007-2015 M-Labs

 BIOS built on Feb 24 2025 13:45:02
 BIOS CRC passed (1cf8ec0e)

 LiteX git sha1: dd54d77db

--=============== SoC ==================--
CPU:            VexRiscv @ 1MHz
BUS:            wishbone 32-bit @ 4GiB
CSR:            32-bit data
ROM:            128.0KiB
SRAM:           8.0KiB


--============== Boot ==================--
Booting from serial...
Press Q or ESC to abort boot completely.
sL5DdSMmkekro
Timeout
No boot medium found

--============= Console ================--

litex>
```

### Arty å‘ã‘ã«ãƒ“ãƒ«ãƒ‰

è¦ç‚¹

- vivado å°å…¥å‰ã« locale ã®è¨­å®šãŒå¿…è¦ (en_US.UTF-8 ã«è¨­å®š)
- WSL2 ã§ã‚ã‚‹ã“ã¨ã€‚ã‚‚ã—ãã¯ä½•ã‚‰ã‹ã® X11 forwading ç’°å¢ƒãŒã‚ã‚‹ã“ã¨ (Vivado install æ™‚ã® GUI è¡¨ç¤ºã«å¿…è¦)
- vivado ã® path ã‚’é€šã™ã“ã¨

#### Vivado å°å…¥

Offline installer ã‚’å–å¾—ã—ã€WSL ä¸Šã§å±•é–‹ã€‚WSL2 ã¯ GUI ã®ç”»é¢è»¢é€ã‚’å…¬å¼ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã®ã§ installer ã® GUI ã¯ãã®ã¾ã¾è¡¨ç¤ºã•ã‚Œã‚‹ã€‚GUI ä¸Šã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é€²ã‚ã‚‹ã€‚

```bash
$ tar -xvf /path/to/FPGAs_AdaptiveSoCs_Unified_2024.2_1113_1001.tar
FPGAs_AdaptiveSoCs_Unified_2024.2_1113_1001/payload/rdi_0006_2024.2_1113_1001.xz
FPGAs_AdaptiveSoCs_Unified_2024.2_1113_1001/payload/rdi_0380_2024.2_1113_1001.xz
FPGAs_AdaptiveSoCs_Unified_2024.2_1113_1001/payload/rdi_0035_2024.2_1113_1001.xz
FPGAs_AdaptiveSoCs_Unified_2024.2_1113_1001/payload/sdnet_0001_2024.2_1113_1001.xz
FPGAs_AdaptiveSoCs_Unified_2024.2_1113_1001/payload/rdi_0729_2024.2_1113_1001.xz
...

# locale ã®è¨­å®šã‚’ã—ã¦ãŠã
$ sudo locale-gen "en_US.UTF-8"
$ sudo update-locale LANG=en_US.UTF-8

# setup dir ã«æ¨©é™å¿…è¦ãªã‚±ãƒ¼ã‚¹ã‚ã‚‹ã®ã§ sudo
$ cd FPGAs_AdaptiveSoCs_Unified_2024.2_1113_1001
$ sudo ./xsetup

# ä»¥å¾Œ GUI Setup

# bashrc ã«ã¦ç’°å¢ƒå¤‰æ•°è¨­å®š
$ echo 'source /tools/Xilinx/Vivado/2024.2/settings64.sh' >> ~/.bashrc

```

#### è«–ç†åˆæˆ

vivado ã« path ãŒé€šã£ã¦ã„ã‚Œã°ã€Vivado ã‚’ä½¿ã† FPGA ã®åˆæˆãŒé€šã‚‹ã¯ãšã€‚

`litex-boards/litex_boards/targets/` ã«ãƒœãƒ¼ãƒ‰å®šç¾©ãŒã‚ã‚‹ã®ã§ã“ã‚Œã® help ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€build,load,flash ãªã©åˆæˆåŠã³æ›¸ãè¾¼ã¿ã«é–¢ã™ã‚‹æƒ…å ±ã¨ã€ãƒœãƒ¼ãƒ‰ä¸Šã® HW (usb/ethernet/....) ã®æœ‰åŠ¹ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆã€CPU ã®è¨­å®šç­‰ã€…ãŒã‚ã‚‹ã€‚
WSL ä¸Šã‹ã‚‰ã®ç›´æ¥æ›¸ãè¾¼ã¿ã¯ hw_server ã‚’ Host å´ã§ç«‹ã¦ã‚Œã°ã„ã‘ã‚‹ã¯ãšã ãŒã€ä»Šå›ã®ä¸»ç›®çš„ã¯ LiteX ç«‹ã¡ä¸Šã’ãªã®ã§ã€ Windows å´ã® Vivado ã§æ›¸ãè¾¼ã‚€ã“ã¨ã«ã™ã‚‹ã€‚

```bash
$ python litex-boards/litex_boards/targets/digilent_arty.py --build
...
Creating config memory files...
Creating bitstream load up from address 0x00000000
Loading bitfile digilent_arty.bit
Writing file ./digilent_arty.bin
Writing log file ./digilent_arty.prm
===================================
Configuration Memory information
===================================
File Format        BIN
Interface          SPIX4
Size               16M
Start Address      0x00000000
End Address        0x00FFFFFF

Addr1         Addr2         Date                    File(s)
0x00000000    0x0021728B    Feb 24 16:20:10 2025    digilent_arty.bit
0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.
write_cfgmem completed successfully
# quit
INFO: [Common 17-206] Exiting Vivado at Mon Feb 24 16:20:11 2025...
```

#### æ›¸ãè¾¼ã¿ (bitstream)

`\build\digilent_arty\gateware` ã« Vivado ã® Project ä¸€å¼ãŒã‚ã‚‹ã®ã§ã€Windows å´ã® Vivado Hardware Manager ã§ `digilent_arty.bin` wishbone æ›¸ãè¾¼ã‚€ã€‚

![screenshot](/images/6aaae326ba7731/config-bitstream.png)

#### æ›¸ãè¾¼ã¿ (SPI Flash)

åŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `digilent_arty.bin` ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’ SPI Flash ã«æ›¸ãè¾¼ã‚€ã€‚
å›è·¯å›³ã‚ˆã‚Šæ­è¼‰ã•ã‚Œã¦ã„ã‚‹ SPI Flash ã¯ N25Q128A13ESF40 ãªã®ã§ã€Add Configuration Memory Device ã§ã“ã‚Œ (ã¨åŒã˜ Cmd Set ã‚’æŒã£ã¦ã„ãã†ãªãƒ‡ãƒã‚¤ã‚¹) ã‚’æŒ‡å®šã€‚

![screenshot](/images/6aaae326ba7731/config-spiflash.png)

ã“ã‚Œã§ FPGA ã®é›»æºã‚’å…¥ã‚Œç›´ã—ã¦ã‚‚ã€LiteX ãŒèµ·å‹•ã™ã‚‹ã‚ˆã†ã«ãªã‚‹ã¯ãšã€‚

### ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰ãƒ»å‹•ä½œç¢ºèª

è‡ªå‰ã§ RISC-V toolchain ã‚’ç”¨æ„ã—ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚‚è‰¯ã‹ã£ãŸãŒã€åˆ‡ã‚Šåˆ†ã‘ãŒé¢å€’ã«ãªã‚Šãã†ãªã®ã§ã¾ãšã¯ Demo Application ã‚’å‹•ä½œã•ã›ã‚‹ã€‚ã€‚
<https://github.com/enjoy-digital/litex/tree/master/litex/soc/software/demo#readme> ã®æ‰‹é †ã«å¾“ã„ `demo.bin` ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã€‚

```bash
$ itex_bare_metal_demo --build-path=build/digilent_arty
```

- <https://github.com/cr1901/teraterm-litex/releases> ã‹ã‚‰ install
- teraterm ã®è»¢é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã•ã‚ŒãŸ `litex` ã‚’ä½¿ç”¨ã— `demo.bin` ã‚’ 0x40000000 ã«è»¢é€ã™ã‚‹è¨­å®š + Acitve=true ã«è¨­å®š
  - ![screenshot](/images/6aaae326ba7731/teraterm-litex-2.png)
- VexRiscv ã‚’å†èµ·å‹•ã™ã‚‹ã‹ã€Terminal ä¸­ã§ `serialboot` ã‚’å…¥åŠ›ã—ã€ `L5DdSMmkekro` ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰è»¢é€ãŒé–‹å§‹ã•ã‚Œã‚‹
- ç„¡äº‹ã« demo app ãŒèµ·å‹•ã—ãŸã‚‰ã€ `donut` ã‚’å…¥åŠ›ã—ã¦ç„¡äº‹å‹•ä½œç¢ºèª OK
  - ![screenshot](/images/6aaae326ba7731/teraterm-litex-3.png)

---

## Troubleshooting

æˆ¦è¡“ã®å†…å®¹ã‚’å®Ÿè¡Œã—ãŸéš›ã®çµŒç·¯ç­‰ã€…ã€‚

### migen å°å…¥æ™‚ã® `python -m pip install` ãŒé€šã‚‰ãªã„

PEP 668 ã«å¾“ã„ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç ´å£Šã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚å¼¾ã‹ã‚Œã¦ã„ã‚‹ã€‚

```sh
$ python3 ./litex_setup.py --init --install --user --config=full
...

[   0.451] Installing migen Git repository...

error: externally-managed-environment

Ã— This environment is externally managed
â•°â”€> To install Python packages system-wide, try apt install
    python3-xyz, where xyz is the package you are trying to
    install.

    If you wish to install a non-Debian-packaged Python package,
    create a virtual environment using python3 -m venv path/to/venv.
    Then use path/to/venv/bin/python and path/to/venv/bin/pip. Make
    sure you have python3-full installed.

    If you wish to install a non-Debian packaged Python application,
    it may be easiest to use pipx install xyz, which will manage a
    virtual environment for you. Make sure you have pipx installed.

    See /usr/share/doc/python3.12/README.venv for more information.

note: If you believe this is a mistake, please contact your Python installation or OS distribution provider. You can override this, at the risk of breaking your Python installation or OS, by passing --break-system-packages.
hint: See PEP 668 for the detailed specification.
Traceback (most recent call last):
  File "/mnt/e/repos/litex/./litex_setup.py", line 497, in <module>
    main()
  File "/mnt/e/repos/litex/./litex_setup.py", line 477, in main
    litex_setup_install_repos(config=args.config, user_mode=args.user)
  File "/mnt/e/repos/litex/./litex_setup.py", line 290, in litex_setup_install_repos
    subprocess.check_call("\"{python3}\" -m pip install {editable} . {options}".format(
  File "/usr/lib/python3.12/subprocess.py", line 413, in check_call
    raise CalledProcessError(retcode, cmd)
```

ã‚¨ãƒ©ãƒ¼è¨˜è¼‰ã®ã¨ãŠã‚Šä»®æƒ³ç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹

```sh
# venvå°å…¥
$ sudo apt install python3-venv
# ä»®æƒ³ç’°å¢ƒä½œæˆ + activate
$ python3 -m venv .venv
$ source .venv/bin/activate
# å†å®Ÿè¡Œ
$ python3 ./litex_setup.py --init --install --user --config=full
```

### ä¸Šè¨˜å¯¾å¿œã—ãŸå¾Œã« `--user` ã® pip install ãŒé€šã‚‰ãªã„

```sh
[   0.065] Installing migen Git repository...
ERROR: Can not perform a '--user' install. User site-packages are not visible in this virtualenv.
Traceback (most recent call last):
  File "/mnt/e/repos/litex/./litex_setup.py", line 497, in <module>
    main()
  File "/mnt/e/repos/litex/./litex_setup.py", line 477, in main
    litex_setup_install_repos(config=args.config, user_mode=args.user)
  File "/mnt/e/repos/litex/./litex_setup.py", line 290, in litex_setup_install_repos
    subprocess.check_call("\"{python3}\" -m pip install {editable} . {options}".format(
  File "/usr/lib/python3.12/subprocess.py", line 413, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command '"/mnt/e/repos/litex/.venv/bin/python3" -m pip install  . --user' returned non-zero exit status 1.
```

pip ã® install å…ˆã¯ global, user, virtualenv ã® 3 æ®µéšã‚ã‚‹ã€‚
`litex_setup.py` ã® `--user` option ã‚’å¤–ã›ã°ã‚ˆã„ãŒã“ã‚Œã¯ global ã«ãªã‚‹ã®ã§é¿ã‘ãŸã„ã€‚

ä»Šå›ã®ã‚¨ãƒ©ãƒ¼ã¯ user install ã‚’ virtualenv ä¸Šã§å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãŸã‚ã«èµ·ãã¦ã„ã‚‹ã€‚

ã‚„ã‚„ã“ã—ã„ã®ã§è¡¨ã«ã¾ã¨ã‚ã‚‹ã€‚ç¾åœ¨é­é‡ã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ãŒ 4 ã«è©²å½“ã™ã‚‹ã€‚

| #   | ä»®æƒ³ç’°å¢ƒ | `--user` | install å…ˆ                                    | location                                  |
| --- | -------- | -------- | --------------------------------------------- | ----------------------------------------- |
| 1   | ãªã—     | ãªã—     | System                                        | `/usr/local/lib/python3.12/dist-packages` |
| 2   | ãªã—     | ã‚ã‚Š     | User                                          | `~/.local/lib/python3.12/site-packages`   |
| 3   | ã‚ã‚Š     | ãªã—     | Virtualenv                                    | `.venv/lib/python3.12/site-packages`      |
| 4   | ã‚ã‚Š     | ã‚ã‚Š     | User (w/ `include-system-site-packages=true`) | `~/.local/lib/python3.12/site-packages`   |

`.venv/pyvenv.cfg` ã« `include-system-site-packages = false` ãŒã‚ã‚‹å ´åˆã¯ 4 ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŒã€ `true` ã«è¨­å®šã™ã‚‹ã¨ User install ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚User install ã§æ§‹ã‚ãªã„ã®ã§ã‚ã‚Œã°ã“ã‚Œã‚‚è§£æ±ºç­–ã§ã¯ã‚ã‚‹ã€‚ (venv ã‚’åˆ‡ã£ãŸæ„å‘³ã¯ç„¡ã•ãã†)

ä»Šå›ã¯ã€ 3. ã‚’é¸æŠã™ã‚‹ã“ã¨ã«ã—ã€ `litex_setup.py` ã‹ã‚‰ `--user` ã‚’å¤–ã—ã¦å®Ÿè¡Œã™ã‚‹ã€‚

```bash
$ source .venv/bin/activate
$ python3 ./litex_setup.py --init --install  --user --config=full
```

### ä¸Šä½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« subrepo ã‚’ã°ã‚‰ã¾ã„ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹

`litex_setup.py` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ é€šå¸¸åŒä¸€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»–ã®ãƒªãƒã‚¸ãƒˆãƒªãŒå±•é–‹ã•ã‚Œã‚‹ã€‚
litex ã® git repo ã”ã¨å–å¾—ã—ã¦å®Ÿè¡Œã—ã¦ã„ãŸãŒã€å®Ÿè¡Œç®‡æ‰€ãŒ git repo ã®å ´åˆã¯ä¸Šä½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å±•é–‹ã•ã‚Œã‚‹ã‚ˆã†ã ã£ãŸã€‚

Quick Start Guide é€šã‚Šã€ `litex_setup.py` ã®ã¿ã‚’å–å¾—ã—ã¦å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã€‚

### vivado ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ãƒ»å®Ÿè¡Œæ™‚ã« locale ã®ã‚¨ãƒ©ãƒ¼

ä»¥ä¸‹è¡¨ç¤ºã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¤±æ•—ã€‚vivado è‡ªä½“ã¯ã‚ã‚‹ã®ã§å®Ÿè¡Œã§ãã‚‹ãŒåŒæ§˜ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

```bash
######## Execution of Pre/Post Installation Tasks Failed ########
Warning: AMD software was installed successfully, but an unexpected status was returned from the following post installation task(s) /tools/Xilinx/Vivado/2024.2/bin/rdiArgs.sh: line 37: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8): No such file or directory /bin/bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8) terminate called after throwing an instance of 'std::runtime_error' what(): locale::facet::_S_create_c_locale name not valid /tools/Xilinx/Vivado/2024.2/bin/rdiArgs.sh: line 421: 74809 Aborted "$RDI_PROG" "$@" /tools/Xilinx/Vivado/2024.2/bin/rdiArgs.sh: line 37: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8): No such file or directory /bin/bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8) terminate called after throwing an instance of 'std::runtime_error' what(): locale::facet::_S_create_c_locale name not valid /tools/Xilinx/Vivado/2024.2/bin/rdiArgs.sh: line 421: 74902 Aborted "$RDI_PROG" "$@"
```

en_US.UTF-8 ã® locale ã‚’è¨­å®šã™ã‚‹ã€‚

å‚è€ƒ: <https://adaptivesupport.amd.com/s/question/0D54U00006FYojlSAD/vivado-20222-on-ubuntu-with-error-lcall-cannot-change-locale-enusutf8?language=ja>

```bash
$ sudo locale-gen "en_US.UTF-8"
$ sudo update-locale LANG=en_US.UTF-8
```
