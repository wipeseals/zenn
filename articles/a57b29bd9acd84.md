---
title: "RustでUSB Mass Storage Class Bulk-Only Transportを実装する"
emoji: "🍣"
type: "tech"
topics: ["Rust", "USB", "Embedded", "raspberrypi", "Tech"]
published: false
---

掲題の通り Rust で USB Mass Storage Class Bulk-Only Transport を実装した。
RAM 上の値を Disk Drive に見せかけたデバイスとして Windows から認識できるようになったので要所を書き残す。

実装には Rust を使用し、 Raspberry pi pico (rp2040) 上で動作確認を行っている。実装の Framework には [embassy-rs](https://github.com/embassy-rs/embassy) を使用した。

## USB 通信の構成・設定

以下のような通信を行う。Bulk Transfer の中身については次項。

![usb-config.png](/images/a57b29bd9acd84/usb-config.png)

### Descriptor 構成

- USB Device
  - Device Descriptor (MSC Bulk Only Transport)
  - Configuration Descriptor
    - Interface Descriptor0 (MSC Bulk Only Transport)
      - Endpoint Descriptor1: Bulk out
      - Endpoint Descriptor2: Bulk in

### USB Mass Storage Class

USB（に限らない話だが）を用いた通信は Host/Device 双方の FW で共通のプロトコル定義に基づいた実装が必要だが、一般的に使われる機能については USB の仕様としてクラス定義されている。
:::message
例: キーボード・マウス等入力デバイス定義 [Device Class Definition for Human Interface Devices(HID)](https://usb.org/sites/default/files/hid1_11.pdf)
:::

今日使われている OS で USB が使える環境にあれば、Host 側のドライバ実装はすでに用意されているので、独自のドライバ作成やこれのインストールの手順を省くことができる。
Device 側の FW を定義に基づいて実装するだけで良い。

このクラス定義のうち、外付け記憶装置を制御するために定義されているものの 1 つとして MSC がある。

### USB の転送方法

Bulk-only Transfer の前に Bulk 転送について触れておく。USB の転送方法には主に以下の 4 種類があり、用途次第で使い分けられている。

- Control Transfer
  - デバイスの設定・制御・少量のデータ転送を行い場合
- Bulk Transfer
  - 大量のデータを転送する場合
- Interrupt Transfer
  - 定期的、即時通知が必要な場合
- Isochronous Transfer
  - Audio/Video 等リアルタイム性が求められるデータ転送を行う場合

また 1 つの USB Device は論理的に複数の機能をもたせることができる。この分割単位を Interface と呼ぶ。
Interface が実装している機能次第で転送に必要な線路の種類と数が異なっており、この転送の最小単位を EndPoint と呼ぶ。

- Device Descriptor
  - Class/SubClass/Protocol code (次項参照), VID,PID, 製造元、製品名、シリアルナンバーなどデバイス自身の情報
- Configuration Descriptor
  - Interface Descriptor
    - 対象の機能が必要とする通信次第で複数持てる
    - Endpoint Descriptor
      - 転送方法(Control/Bulk/Interrupt/Isochronous) 、転送方向 (IN/OUT)、PacketSize など
      - Interface が必要な Endpoint の数だけ複数持てる

### Bulk-only Transfer

USB のクラス定義は 同じ MSC でもサブクラス、プロトコルで細分化される。
どのような転送方法を使用するか、どのようなコマンドセットで通信するかを設定値 (Device Descriptor) を Host に報告する。

MSC Bulk-only Transfer は太字の設定を報告する。注意点として、Bulk-only transport という名前ではあるが、一部の要求は Control 転送を用いて要求されるのでこれにも反応できる必要がある。
:::message
Class Request と呼ばれ、EndPoint 0 番目 を使用する。 EndPoint 0 は常に Control 転送に固定されているため、Interface Descriptor > Endpoint Descriptor で報告する必要はない。
0 番目に存在するのは、Descriptor 自体の読み取りや初期設定など基本的な通信で使用するため。
:::

- Class
  - **Mass Storage Class**
- SubClass
  - **SubClass: SCSI transport command set**
  - SubClass: ATAPI command set
  - SubClass: UFI (USB Floppy Interface) command set
- Protocol
  - **[Bulk-Only Transport](https://www.usb.org/sites/default/files/usbmassbulk_10.pdf)**
  - [Control/Bulk/Interrupt Transport](https://usb.org/sites/default/files/usb_msc_cbi_1.1.pdf)

### 実装

embassy が提供している rp2040 向けのサンプルの以下をベースに構築した。

- Control 転送: [usb_raw.rs](https://github.com/embassy-rs/embassy/blob/main/examples/rp/src/bin/usb_raw.rs)
- Bulk 転送: [usb_raw_bulk.rs](https://github.com/embassy-rs/embassy/blob/main/examples/rp/src/bin/usb_raw_bulk.rs)

変更点

- Device Descriptor を MSC Bulk-only Transfer の定義になるよう修正
  - Control 転送と Bulk 転送で異なる Context となるため、Control 転送から Bulk 転送への通知用に Channel を用意
    - Channel: 異なるスレッド間でデータを送受信するための通信線路

TODO: 残り記述

```rust
// TODO: 実装抜粋
```

## コマンド解釈

TODO: 記載
