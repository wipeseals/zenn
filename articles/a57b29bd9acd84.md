---
title: "Rustã§USB Mass Storage Class Bulk-Only Transportã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ£"
type: "tech"
topics: ["Rust", "USB", "Embedded", "raspberrypi", "Tech"]
published: false
---

æ²é¡Œã®é€šã‚Š Rust ã§ USB Mass Storage Class Bulk-Only Transport ã‚’å®Ÿè£…ã—ãŸã€‚
RAM ä¸Šã®å€¤ã‚’ Disk Drive ã«è¦‹ã›ã‹ã‘ãŸãƒ‡ãƒã‚¤ã‚¹ã¨ã—ã¦ Windows ã‹ã‚‰èªè­˜ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§è¦æ‰€ã‚’æ›¸ãæ®‹ã™ã€‚

å®Ÿè£…ã«ã¯ Rust ã‚’ä½¿ç”¨ã—ã€ Raspberry pi pico (rp2040) ä¸Šã§å‹•ä½œç¢ºèªã‚’è¡Œã£ã¦ã„ã‚‹ã€‚å®Ÿè£…ã® Framework ã«ã¯ [embassy-rs](https://github.com/embassy-rs/embassy) ã‚’ä½¿ç”¨ã—ãŸã€‚

## USB é€šä¿¡ã®æ§‹æˆãƒ»è¨­å®š

ä»¥ä¸‹ã®ã‚ˆã†ãªé€šä¿¡ã‚’è¡Œã†ã€‚Bulk Transfer ã®ä¸­èº«ã«ã¤ã„ã¦ã¯æ¬¡é …ã€‚

![usb-config.png](/images/a57b29bd9acd84/usb-config.png)

### Descriptor æ§‹æˆ

- USB Device
  - Device Descriptor (MSC Bulk Only Transport)
  - Configuration Descriptor
    - Interface Descriptor0 (MSC Bulk Only Transport)
      - Endpoint Descriptor1: Bulk out
      - Endpoint Descriptor2: Bulk in

### USB Mass Storage Class

USBï¼ˆã«é™ã‚‰ãªã„è©±ã ãŒï¼‰ã‚’ç”¨ã„ãŸé€šä¿¡ã¯ Host/Device åŒæ–¹ã® FW ã§å…±é€šã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«å®šç¾©ã«åŸºã¥ã„ãŸå®Ÿè£…ãŒå¿…è¦ã ãŒã€ä¸€èˆ¬çš„ã«ä½¿ã‚ã‚Œã‚‹æ©Ÿèƒ½ã«ã¤ã„ã¦ã¯ USB ã®ä»•æ§˜ã¨ã—ã¦ã‚¯ãƒ©ã‚¹å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚
:::message
ä¾‹: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ãƒã‚¦ã‚¹ç­‰å…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹å®šç¾© [Device Class Definition for Human Interface Devices(HID)](https://usb.org/sites/default/files/hid1_11.pdf)
:::

ä»Šæ—¥ä½¿ã‚ã‚Œã¦ã„ã‚‹ OS ã§ USB ãŒä½¿ãˆã‚‹ç’°å¢ƒã«ã‚ã‚Œã°ã€Host å´ã®ãƒ‰ãƒ©ã‚¤ãƒå®Ÿè£…ã¯ã™ã§ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ç‹¬è‡ªã®ãƒ‰ãƒ©ã‚¤ãƒä½œæˆã‚„ã“ã‚Œã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®æ‰‹é †ã‚’çœãã“ã¨ãŒã§ãã‚‹ã€‚
Device å´ã® FW ã‚’å®šç¾©ã«åŸºã¥ã„ã¦å®Ÿè£…ã™ã‚‹ã ã‘ã§è‰¯ã„ã€‚

ã“ã®ã‚¯ãƒ©ã‚¹å®šç¾©ã®ã†ã¡ã€å¤–ä»˜ã‘è¨˜æ†¶è£…ç½®ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã® 1 ã¤ã¨ã—ã¦ MSC ãŒã‚ã‚‹ã€‚

### USB ã®è»¢é€æ–¹æ³•

Bulk-only Transfer ã®å‰ã« Bulk è»¢é€ã«ã¤ã„ã¦è§¦ã‚Œã¦ãŠãã€‚USB ã®è»¢é€æ–¹æ³•ã«ã¯ä¸»ã«ä»¥ä¸‹ã® 4 ç¨®é¡ãŒã‚ã‚Šã€ç”¨é€”æ¬¡ç¬¬ã§ä½¿ã„åˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã€‚

- Control Transfer
  - ãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®šãƒ»åˆ¶å¾¡ãƒ»å°‘é‡ã®ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚’è¡Œã„å ´åˆ
- Bulk Transfer
  - å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã™ã‚‹å ´åˆ
- Interrupt Transfer
  - å®šæœŸçš„ã€å³æ™‚é€šçŸ¥ãŒå¿…è¦ãªå ´åˆ
- Isochronous Transfer
  - Audio/Video ç­‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚’è¡Œã†å ´åˆ

ã¾ãŸ 1 ã¤ã® USB Device ã¯è«–ç†çš„ã«è¤‡æ•°ã®æ©Ÿèƒ½ã‚’ã‚‚ãŸã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã®åˆ†å‰²å˜ä½ã‚’ Interface ã¨å‘¼ã¶ã€‚
Interface ãŒå®Ÿè£…ã—ã¦ã„ã‚‹æ©Ÿèƒ½æ¬¡ç¬¬ã§è»¢é€ã«å¿…è¦ãªç·šè·¯ã®ç¨®é¡ã¨æ•°ãŒç•°ãªã£ã¦ãŠã‚Šã€ã“ã®è»¢é€ã®æœ€å°å˜ä½ã‚’ EndPoint ã¨å‘¼ã¶ã€‚

- Device Descriptor
  - Class/SubClass/Protocol code (æ¬¡é …å‚ç…§), VID,PID, è£½é€ å…ƒã€è£½å“åã€ã‚·ãƒªã‚¢ãƒ«ãƒŠãƒ³ãƒãƒ¼ãªã©ãƒ‡ãƒã‚¤ã‚¹è‡ªèº«ã®æƒ…å ±
- Configuration Descriptor
  - Interface Descriptor
    - å¯¾è±¡ã®æ©Ÿèƒ½ãŒå¿…è¦ã¨ã™ã‚‹é€šä¿¡æ¬¡ç¬¬ã§è¤‡æ•°æŒã¦ã‚‹
    - Endpoint Descriptor
      - è»¢é€æ–¹æ³•(Control/Bulk/Interrupt/Isochronous) ã€è»¢é€æ–¹å‘ (IN/OUT)ã€PacketSize ãªã©
      - Interface ãŒå¿…è¦ãª Endpoint ã®æ•°ã ã‘è¤‡æ•°æŒã¦ã‚‹

### Bulk-only Transfer

USB ã®ã‚¯ãƒ©ã‚¹å®šç¾©ã¯ åŒã˜ MSC ã§ã‚‚ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ç´°åˆ†åŒ–ã•ã‚Œã‚‹ã€‚
ã©ã®ã‚ˆã†ãªè»¢é€æ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ã©ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚»ãƒƒãƒˆã§é€šä¿¡ã™ã‚‹ã‹ã‚’è¨­å®šå€¤ (Device Descriptor) ã‚’ Host ã«å ±å‘Šã™ã‚‹ã€‚

MSC Bulk-only Transfer ã¯å¤ªå­—ã®è¨­å®šã‚’å ±å‘Šã™ã‚‹ã€‚æ³¨æ„ç‚¹ã¨ã—ã¦ã€Bulk-only transport ã¨ã„ã†åå‰ã§ã¯ã‚ã‚‹ãŒã€ä¸€éƒ¨ã®è¦æ±‚ã¯ Control è»¢é€ã‚’ç”¨ã„ã¦è¦æ±‚ã•ã‚Œã‚‹ã®ã§ã“ã‚Œã«ã‚‚åå¿œã§ãã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
:::message
Class Request ã¨å‘¼ã°ã‚Œã€EndPoint 0 ç•ªç›® ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ EndPoint 0 ã¯å¸¸ã« Control è»¢é€ã«å›ºå®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€Interface Descriptor > Endpoint Descriptor ã§å ±å‘Šã™ã‚‹å¿…è¦ã¯ãªã„ã€‚
0 ç•ªç›®ã«å­˜åœ¨ã™ã‚‹ã®ã¯ã€Descriptor è‡ªä½“ã®èª­ã¿å–ã‚Šã‚„åˆæœŸè¨­å®šãªã©åŸºæœ¬çš„ãªé€šä¿¡ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã€‚
:::

- Class
  - **Mass Storage Class**
- SubClass
  - **SubClass: SCSI transport command set**
  - SubClass: ATAPI command set
  - SubClass: UFI (USB Floppy Interface) command set
- Protocol
  - **[Bulk-Only Transport](https://www.usb.org/sites/default/files/usbmassbulk_10.pdf)**
  - [Control/Bulk/Interrupt Transport](https://usb.org/sites/default/files/usb_msc_cbi_1.1.pdf)

### å®Ÿè£…

embassy ãŒæä¾›ã—ã¦ã„ã‚‹ rp2040 å‘ã‘ã®ã‚µãƒ³ãƒ—ãƒ«ã®ä»¥ä¸‹ã‚’ãƒ™ãƒ¼ã‚¹ã«æ§‹ç¯‰ã—ãŸã€‚

- Control è»¢é€: [usb_raw.rs](https://github.com/embassy-rs/embassy/blob/main/examples/rp/src/bin/usb_raw.rs)
- Bulk è»¢é€: [usb_raw_bulk.rs](https://github.com/embassy-rs/embassy/blob/main/examples/rp/src/bin/usb_raw_bulk.rs)

å¤‰æ›´ç‚¹

- Device Descriptor ã‚’ MSC Bulk-only Transfer ã®å®šç¾©ã«ãªã‚‹ã‚ˆã†ä¿®æ­£
  - Control è»¢é€ã¨ Bulk è»¢é€ã§ç•°ãªã‚‹ Context ã¨ãªã‚‹ãŸã‚ã€Control è»¢é€ã‹ã‚‰ Bulk è»¢é€ã¸ã®é€šçŸ¥ç”¨ã« Channel ã‚’ç”¨æ„
    - Channel: ç•°ãªã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã™ã‚‹ãŸã‚ã®é€šä¿¡ç·šè·¯

TODO: æ®‹ã‚Šè¨˜è¿°

```rust
// TODO: å®Ÿè£…æŠœç²‹
```

## ã‚³ãƒãƒ³ãƒ‰è§£é‡ˆ

TODO: è¨˜è¼‰
